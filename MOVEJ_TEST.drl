# ============================
# Stage A: Shelf1<->Shelf2 : movej 연속 3번 왕복 (HOME 반복 방문 X)
# Stage B: Shelf2->Shelf3 :
#   - Shelf2 픽은 "티칭된 q_s2[0..2]"로만 접근 (계산 posx 제거 = workspace 근본 해결)
#   - Shelf3는 posx 1점 고정 + solution1(접근 base 자세, 놓을 때만 tilt)
# ============================

Z_UP = 100.0
INSPECT_TIME = 2.0

V_FAST = 70
A_FAST = 70
V_SLOW = 20
A_SLOW = 20

VJ = 70
AJ = 70

HOME_P = posx(367.22, 3.83, 201.28, 158.41, 179.96, 158.79)

S3_BASE = (429.06,  213.83,  87.06, 152.93,  179.97, 155.34)  # Shelf3 fixed (posx)

# Shelf1 micro motion (Stage A)
S1_PICK_PUSH_X = 20.0
S1_PICK_PULL_X = -10.0
S1_BEFORE_CLOSE_WAIT = 0.5

# Shelf3 tilt: "기존 자세 기준으로" B만 덧붙임 (workspace 안전)
S3_PITCH_DELTA_DEG = 20.0   # <- 먼저 10~20으로 안정화 후 30~40으로 올려
S3_PITCH_SIGN = -1.0        # 방향 반대면 +1 / -1만 바꾸기


def do_homing():
    pass


# -------------------------
# Gripper
# -------------------------
def open_gripper():
    set_digital_output(2, ON)
    wait(1.00)
    set_digital_output(2, OFF)

def close_gripper():
    set_digital_output(1, ON)
    wait(1.00)
    set_digital_output(1, OFF)


# -------------------------
# MOVEJ targets (티칭값)
# -------------------------
q_s1 = [
    [30.62, 18.12, 122.74, -146.41, 57.81, 161.67],
    [40.95, 24.14, 113.02, -133.93, 59.29, 152.80],
    [49.59, 30.45, 102.15, -123.56, 61.19, 144.29],
]
q_s2 = [
    [-31.45, 19.05, 69.88, 0.07, 91.00, -30.92],
    [-28.24, 27.55, 54.35, 0.11, 98.04, -27.66],
    [-25.60, 37.51, 39.08, 0.17, 103.36, -24.97],
]

def goj(q):
    movej(q, v=VJ, a=AJ)

def go_home():
    movel(HOME_P, v=V_FAST, a=A_FAST)


# -------------------------
# Robust current posx extractor + rel move
# -------------------------
def _extract_posx6(p):
    try:
        if (len(p) >= 6):
            return p[0], p[1], p[2], p[3], p[4], p[5]
    except:
        pass

    try:
        if (len(p) >= 1):
            p0 = p[0]
            if (len(p0) >= 6):
                return p0[0], p0[1], p0[2], p0[3], p0[4], p0[5]
    except:
        pass

    tp_popup("get_current_posx() format unexpected:\n" + str(p))
    raise Exception("Cannot extract 6D pose from get_current_posx()")


def move_rel_x(dx, v=V_SLOW, a=A_SLOW):
    p = get_current_posx()
    x, y, z, A, B, C = _extract_posx6(p)
    movel(posx(x + dx, y, z, A, B, C), v=v, a=a)


def _wrap_deg(a):
    while a > 180.0:
        a = a - 360.0
    while a < -180.0:
        a = a + 360.0
    return a


# -------------------------
# Shelf3 pose helpers (base + tilt-from-base)
# -------------------------
def s3_app_pose_base():
    x0, y0, z0, A0, B0, C0 = S3_BASE
    return posx(x0, y0, z0 + Z_UP, A0, B0, C0)

def s3_work_pose_base():
    x0, y0, z0, A0, B0, C0 = S3_BASE
    return posx(x0, y0, z0, A0, B0, C0)

def s3_work_pose_tilt_from_base():
    x0, y0, z0, A0, B0, C0 = S3_BASE
    B = _wrap_deg(B0 + S3_PITCH_SIGN * S3_PITCH_DELTA_DEG)
    return posx(x0, y0, z0, A0, B, C0)


# ============================================================
# Stage A: Shelf1<->Shelf2 (HOME 반복 방문 없이) 3번 연속 왕복
# ============================================================
def stageA_s1_s2_roundtrip_3cycles_no_home():
    go_home()
    wait(0.3)

    for i in range(3):
        open_gripper()
        wait(0.1)

        goj(q_s1[i])
        wait(0.2)

        move_rel_x(S1_PICK_PUSH_X, v=V_SLOW, a=A_SLOW)
        wait(S1_BEFORE_CLOSE_WAIT)
        close_gripper()
        wait(0.2)
        move_rel_x(S1_PICK_PULL_X, v=V_SLOW, a=A_SLOW)
        wait(0.1)

        goj(q_s2[i])
        wait(0.2)

        wait(INSPECT_TIME)

        open_gripper()
        wait(0.2)


# ============================================================
# Stage B (진짜 해결 버전):
#   - Shelf2 픽: 계산 posx(=S2_BASE+i*60) 완전 제거
#              티칭된 q_s2[i]로만 접근 -> close
#   - Shelf3 플레이스: posx 1점 고정 + solution1(접근 base, work에서만 tilt)
# ============================================================
def stageB_s2_s3_pick_qs2_place_s3fixed_tilt_3cycles():
    for i in range(3):
        # --- Shelf2(i)에서 집기: movej로 확실히 도달 가능한 점만 사용 ---
        goj(q_s2[i])
        wait(0.2)

        close_gripper()
        wait(0.2)

        # --- (옵션) 안전 이탈: Home을 경유하면 직선보다 느리지만 workspace 최강 안정 ---
        # 필요 없으면 주석 처리 가능
        go_home()
        wait(0.1)

        # --- Shelf3: 접근/내려감은 base 자세로 ---
        movel(s3_app_pose_base(),  v=V_FAST, a=A_FAST)
        movel(s3_work_pose_base(), v=V_SLOW, a=A_SLOW)
        wait(0.1)

        # --- 같은 점에서만 tilt 자세로 잠깐 변경 후 놓기 ---
        movel(s3_work_pose_tilt_from_base(), v=V_SLOW, a=A_SLOW)
        wait(0.1)

        open_gripper()
        wait(0.2)

        # --- base로 복귀 후 이탈 ---
        movel(s3_work_pose_base(), v=V_SLOW, a=A_SLOW)
        movel(s3_app_pose_base(),  v=V_FAST, a=A_FAST)
        wait(0.1)


def main():
    stageA_s1_s2_roundtrip_3cycles_no_home()
    stageB_s2_s3_pick_qs2_place_s3fixed_tilt_3cycles()

    do_homing()
    go_home()

main()

# ============================
# Stage A: Shelf1<->Shelf2 : movej로 3번 왕복 (q_s1/q_s2 사용)
# Stage B: Shelf2->Shelf3 : movel로 3번 직선 운반
#   - Shelf2: x + 60*i
#   - Shelf3: x - 60*i
# ============================

Z_UP = 100.0
INSPECT_TIME = 2.0

V_FAST = 70
A_FAST = 70
V_SLOW = 20
A_SLOW = 20

# movej 속도/가속
VJ = 70
AJ = 70

HOME_P = posx(367.22, 3.83, 201.28, 158.41, 179.96, 158.79)

S2_BASE = (429.80, -258.59, 185.82, 115.72, -179.93, 116.62)  # Shelf2 slot0 (posx)
S3_BASE = (429.06,  213.83,  87.06, 152.93,  179.97, 155.34)  # Shelf3 slot0 (posx)

# Stage B step
S2_STEP_X = 60.0
S3_STEP_X = -60.0


def do_homing():
    pass


# -------------------------
# Gripper
# -------------------------
def open_gripper():
    set_digital_output(2, ON)
    wait(1.00)
    set_digital_output(2, OFF)

def close_gripper():
    set_digital_output(1, ON)
    wait(1.00)
    set_digital_output(1, OFF)


# -------------------------
# MOVEJ targets (이미 티칭한 값 사용)
# -------------------------
q_s1 = [
    [30.62, 18.12, 122.74, -146.41, 57.81, 161.67],  # Shelf1 idx0 (pick)
    [40.95, 24.14, 113.02, -133.93, 59.29, 152.80],  # Shelf1 idx1 (pick)
    [49.59, 30.45, 102.15, -123.56, 61.19, 144.29],  # Shelf1 idx2 (pick)
]
q_s2 = [
    [-31.45, 19.05, 69.88, 0.07, 91.00, -30.92],     # Shelf2 idx0 (place/inspect)
    [-28.24, 27.55, 54.35, 0.11, 98.04, -27.66],     # Shelf2 idx1 (place/inspect)
    [-25.60, 37.51, 39.08, 0.17, 103.36, -24.97],    # Shelf2 idx2 (place/inspect)
]

def goj(q):
    movej(q, v=VJ, a=AJ)

def go_home():
    movel(HOME_P, v=V_FAST, a=A_FAST)


# -------------------------
# Stage B: MOVEL pose helpers (선반별 step 반영)
# -------------------------
def s2_work_pose(i):
    x0, y0, z0, A0, B0, C0 = S2_BASE
    return posx(x0 + i * S2_STEP_X, y0, z0, A0, B0, C0)

def s2_app_pose(i):
    x0, y0, z0, A0, B0, C0 = S2_BASE
    return posx(x0 + i * S2_STEP_X, y0, z0 + Z_UP, A0, B0, C0)

def s3_work_pose(i):
    x0, y0, z0, A0, B0, C0 = S3_BASE
    return posx(x0 + i * S3_STEP_X, y0, z0, A0, B0, C0)

def s3_app_pose(i):
    x0, y0, z0, A0, B0, C0 = S3_BASE
    return posx(x0 + i * S3_STEP_X, y0, z0 + Z_UP, A0, B0, C0)


def movel_pick_s2(i):
    # approach -> work -> grip close -> leave
    movel(s2_app_pose(i),  v=V_FAST, a=A_FAST)
    movel(s2_work_pose(i), v=V_SLOW, a=A_SLOW)
    wait(0.2)

    close_gripper()
    wait(0.2)

    movel(s2_app_pose(i),  v=V_FAST, a=A_FAST)
    wait(0.1)


def movel_place_s3(i):
    # approach -> work -> grip open -> leave
    movel(s3_app_pose(i),  v=V_FAST, a=A_FAST)
    movel(s3_work_pose(i), v=V_SLOW, a=A_SLOW)
    wait(0.2)

    open_gripper()
    wait(0.2)

    movel(s3_app_pose(i),  v=V_FAST, a=A_FAST)
    wait(0.1)


# ============================================================
# Stage A: Shelf1 -> Shelf2 (movej 왕복) x3
# ============================================================
def stageA_s1_s2_movej_3cycles():
    for i in range(3):
        # Shelf1(i) pick
        goj(q_s1[i])
        wait(0.2)

        open_gripper()
        wait(0.2)
        close_gripper()
        wait(0.2)

        # Shelf2(i) place + inspect
        goj(q_s2[i])
        wait(0.2)

        open_gripper()
        wait(0.2)

        wait(INSPECT_TIME)


# ============================================================
# Stage B: Shelf2 -> Shelf3 (movel) x3
#   Shelf2: x + 60*i
#   Shelf3: x - 60*i
# ============================================================
def stageB_s2_s3_movel_3cycles():
    for i in range(3):
        movel_pick_s2(i)
        movel_place_s3(i)


def main():
    go_home()
    wait(0.5)

    stageA_s1_s2_movej_3cycles()
    stageB_s2_s3_movel_3cycles()

    do_homing()
    go_home()

main()

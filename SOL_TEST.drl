# ============================================================
# DRL Motion Benchmark (SYNC/ASYNC x movej/movel) + IK wrapper
# - DRL 호환: f-string/for-in/튜플 언패킹/format 제거
# - 결과는 ms 단위로 tp_popup 출력
# ============================================================

# --------------------------
# Test points (posx, mm/deg)  ✅ 사용자 지정 P1/P2
# --------------------------
P1 = posx(722.28, 200.46, 201.28, 158.41, 179.96, 158.79)              # 위치 1
P2 = posx(379.89, -247.05, 115.68, 114.63, -179.93, 115.51)            # 위치 2

# --------------------------
# Speed/Acc
# --------------------------
VJ = 70
AJ = 70
VL = 70
AL = 70
DWELL = 0.10
N_ROUNDTRIP = 5

# --------------------------
# IK settings (필요 시 SOL_SPACE만 수정)
# --------------------------
# 네 환경에서 DR_SOL_SPACE_BASE가 없으면 자동완성에 뜨는 값으로 변경:
# 예) DR_SOL_SPACE_TASK, DR_SOL_SPACE_WORLD, DR_SOL_SPACE_JOINT ...
SOL_SPACE = DR_SOL_SPACE_BASE
IK_SOL_IDX = 0

def ik_posx_to_joint(p):
    # 네 환경에서 ikin_norm이 (pose, sol_space, sol_idx) 형태라고 가정
    return ikin_norm(p, SOL_SPACE, IK_SOL_IDX)

# --------------------------
# Time (ms)
# --------------------------
def now_ms():
    return get_current_time_ms()

# --------------------------
# Wait motion done (환경에 맞게 수정)
# --------------------------
def wait_done():
    # 네 환경에서 지원되는 완료 대기 함수로 1개만 남기면 됨
    wait_motion()

# --------------------------
# Motion functions
# --------------------------
def go_sync_movej(p):
    q = ik_posx_to_joint(p)
    movej(q, v=VJ, a=AJ)

def go_sync_movel(p):
    movel(p, v=VL, a=AL)

def go_async_movej(p):
    q = ik_posx_to_joint(p)
    movej(q, v=VJ, a=AJ, async=True)

def go_async_movel(p):
    movel(p, v=VL, a=AL, async=True)

# --------------------------
# Run a benchmark case
# returns elapsed_ms (int)
# --------------------------
def run_case(case_name, go_func, async_mode):
    tp_popup("START: " + case_name)

    t0 = now_ms()

    k = 0
    while k < N_ROUNDTRIP:
        # P1 -> P2
        go_func(P2)
        if async_mode:
            wait_done()
        wait(DWELL)

        # P2 -> P1
        go_func(P1)
        if async_mode:
            wait_done()
        wait(DWELL)

        k = k + 1

    wait_done()

    t1 = now_ms()
    dt_ms = t1 - t0

    tp_popup(case_name + " DONE: " + str(dt_ms) + " ms")
    return dt_ms

# --------------------------
# Main
# --------------------------
def main():
    # 시작 위치 안정화
    movel(P1, v=VL, a=AL)
    wait_done()
    wait(0.2)

    # results: [[name, dt_ms], ...]
    results = []

    dt1 = run_case("SYNC + movej(ikin_norm)", go_sync_movej, False)
    results.append(["SYNC + movej(ikin_norm)", dt1])

    dt2 = run_case("SYNC + movel", go_sync_movel, False)
    results.append(["SYNC + movel", dt2])

    dt3 = run_case("ASYNC + movej(ikin_norm)", go_async_movej, True)
    results.append(["ASYNC + movej(ikin_norm)", dt3])

    dt4 = run_case("ASYNC + movel", go_async_movel, True)
    results.append(["ASYNC + movel", dt4])

    tp_popup("RESULTS:")
    i = 0
    while i < len(results):
        name = results[i][0]
        dt_ms = results[i][1]
        tp_popup(name + " = " + str(dt_ms) + " ms")
        i = i + 1

main()

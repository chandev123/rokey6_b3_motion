# ============================================================
# DRL MERGED: Shelf pick -> Shelf2 align(check_slot) -> inspect -> place
# ============================================================

# --------------------------
# Shelf spacing (mm)
# --------------------------
DX = 60.0
DY = 60.0
DZ = 60.0

Z_UP   = 100.0
X_PULL = -100.0

INSPECT_TIME = 4.0

# --------------------------
# Speed/Acc
# --------------------------
V_FAST = 70
A_FAST = 70
V_SLOW = 30
A_SLOW = 30

# Align motion (relative moves)
V_ALIGN = 50
A_ALIGN = 50

# --------------------------
# check_slot params (tune)
# --------------------------
Z_SUCCESS   = 65.0   # 성공 깊이 (환경에 맞게 튜닝)
Z_ENTRY     = 120.0  # 입구 근처라고 판단하는 z 기준(튜닝)
FZ_SUCCESS  = 2.0    # 성공 접촉 힘
FZ_RETRY    = 5.0    # 보정 시작 힘
TORQUE_TH   = 0.6    # 비스듬함 토크 기준 (abs(tx)+abs(ty))

# Force profile (N)
FORCE_FAST  = -30.0
FORCE_ENTRY = -20.0
FORCE_RETRY = -40.0

STIFFNESS_INIT  = [500.0, 500.0, 500.0, 100.0, 100.0, 100.0]
STIFFNESS_RETRY = [1000.0, 1000.0, 1000.0, 100.0, 100.0, 100.0]

XY_STEP = 3.0  # 보정 이동(mm)

# --------------------------
# Poses (mm, deg)
# --------------------------
HOME_P = posx(367.22, 3.83, 201.28, 158.41, 179.96, 158.79)

S1_BASE = (750.39,  200.46, 250.92,   2.36,   88.13,   2.04)
S2_BASE = (429.80, -258.59,  86.78, 115.36, -179.93, 116.26)
S3_BASE = (429.06,  213.83,  87.04, 154.82,  179.97, 155.23)

S1_AXIS = 'z'
S2_AXIS = 'x'
S3_AXIS = 'x'


# ============================================================
# Gripper (set_digital_output)
# ============================================================
def open_gripper():
    set_digital_output(2, ON)
    wait(0.3)
    set_digital_output(2, OFF)

def close_gripper():
    set_digital_output(1, ON)
    wait(0.3)
    set_digital_output(1, OFF)


# ============================================================
# Slot pose utilities
# ============================================================
def slot_pose(base, i, axis):
    x0, y0, z0, A0, B0, C0 = base
    x, y, z = x0, y0, z0

    if axis == 'x':
        x = x0 + i * DX
    elif axis == 'y':
        y = y0 + i * DY
    elif axis == 'z':
        z = z0 + i * DZ

    return posx(x, y, z, A0, B0, C0)

def app_pose_zup(base, i, axis):
    p = slot_pose(base, i, axis)
    return posx(p[0], p[1], p[2] + Z_UP, p[3], p[4], p[5])

def app_pose_xpull(base, i, axis, x_pull):
    p = slot_pose(base, i, axis)
    return posx(p[0] + x_pull, p[1], p[2], p[3], p[4], p[5])


# ============================================================
# Basic moves
# ============================================================
def go_home():
    movel(HOME_P, v=V_FAST, a=A_FAST)

def go_slot_zup(base, i, axis):
    p_app  = app_pose_zup(base, i, axis)
    p_work = slot_pose(base, i, axis)
    movel(p_app,  v=V_FAST, a=A_FAST)
    movel(p_work, v=V_SLOW, a=A_SLOW)

def leave_slot_zup(base, i, axis):
    p_app = app_pose_zup(base, i, axis)
    movel(p_app, v=V_FAST, a=A_FAST)

def go_slot_xpull(base, i, axis, x_pull):
    p_app  = app_pose_xpull(base, i, axis, x_pull)
    p_work = slot_pose(base, i, axis)
    movel(p_app,  v=V_FAST, a=A_FAST)
    movel(p_work, v=V_SLOW, a=A_SLOW)

def leave_slot_xpull(base, i, axis, x_pull):
    p_app = app_pose_xpull(base, i, axis, x_pull)
    movel(p_app, v=V_FAST, a=A_FAST)


# ============================================================
# Relative Z helpers (for correction)
# ============================================================
def z_up_rel():
    movel(posx(0, 0, 10, 0, 0, 0), v=V_ALIGN, a=A_ALIGN, mod=DR_MV_MOD_REL)

def z_down_rel():
    movel(posx(0, 0, -12, 0, 0, 0), v=V_ALIGN, a=A_ALIGN, mod=DR_MV_MOD_REL)


# ============================================================
# Force/Compliance helpers
# ============================================================
def start_force(stiffness, fz):
    task_compliance_ctrl()
    set_stiffnessx(stiffness, time=0.0)
    set_desired_force([0.0, 0.0, fz, 0.0, 0.0, 0.0],
                      [0, 0, 1, 0, 0, 0],
                      time=0.0, mod=DR_FC_MOD_ABS)
    wait(0.3)

def end_force():
    release_force(time=0.0)
    release_compliance_ctrl()


# ============================================================
# Shelf2 Align/Insert algorithm (merged & stabilized)
# ============================================================
def check_slot(max_iter=400):
    """
    - Force로 아래로 누르며 삽입 시도
    - fz/torque 커지면 z-up -> XY 보정 -> z-down 반복
    - 성공(z <= Z_SUCCESS and fz >= FZ_SUCCESS) 시 종료
    """
    start_force(STIFFNESS_INIT, FORCE_FAST)

    cnt = 0
    while True:
        cnt = cnt + 1
        if cnt > max_iter:
            break

        pose, sol = get_current_posx(DR_BASE)
        x, y, z, rx, ry, rz = pose
        fx, fy, fz, tx, ty, tz = get_tool_force()

        # ✅ 성공 조건
        if (z <= Z_SUCCESS) and (fz >= FZ_SUCCESS):
            break

        # ✅ 입구 근처면 힘 조절(너 코드 흐름 유지)
        if z <= Z_ENTRY:
            set_desired_force([0.0, 0.0, FORCE_ENTRY, 0.0, 0.0, 0.0],
                              [0, 0, 1, 0, 0, 0],
                              time=0.0, mod=DR_FC_MOD_ABS)
            wait(0.3)

        # ✅ 비스듬함/걸림 감지(개선: tx!=ty 대신 torque_score)
        torque_score = abs(tx) + abs(ty)
        if (fz >= FZ_RETRY) and (z > Z_SUCCESS) and (torque_score > TORQUE_TH):
            # force off
            end_force()

            # 보정: 위로 -> XY 이동 -> 아래로
            z_up_rel()

            dx = 0.0
            dy = 0.0
            if tx > 0: dx = +XY_STEP
            elif tx < 0: dx = -XY_STEP

            if ty > 0: dy = +XY_STEP
            elif ty < 0: dy = -XY_STEP

            movel(posx(dx, dy, 0, 0, 0, 0), v=V_ALIGN, a=A_ALIGN, mod=DR_MV_MOD_REL)
            z_down_rel()

            # force on 다시
            start_force(STIFFNESS_RETRY, FORCE_RETRY)

        wait(0.05)

    end_force()


# ============================================================
# Task sequences
# ============================================================
def pick_from_shelf1(base, i, axis, x_pull):
    open_gripper()
    wait(0.2)

    go_slot_xpull(base, i, axis, x_pull)

    close_gripper()
    wait(0.3)

    leave_slot_xpull(base, i, axis, x_pull)

def align_and_inspect_at_shelf2(base, i, axis):
    go_slot_zup(base, i, axis)

    # ✅ 여기서 알고리즘 적용
    check_slot(max_iter=400)

    wait(INSPECT_TIME)
    leave_slot_zup(base, i, axis)

def place_to_shelf3(base, i, axis):
    go_slot_zup(base, i, axis)

    open_gripper()
    wait(0.3)

    leave_slot_zup(base, i, axis)


def do_homing():
    pass


# ============================================================
# Main
# ============================================================
def main():
    s1_idx = 0
    s2_idx = 0
    s3_idx = 0

    go_home()

    # 1) Pick from Shelf1
    pick_from_shelf1(S1_BASE, s1_idx, S1_AXIS, X_PULL)
    go_home()

    # 2) Align + Inspect at Shelf2
    align_and_inspect_at_shelf2(S2_BASE, s2_idx, S2_AXIS)

    # 3) Place to Shelf3
    place_to_shelf3(S3_BASE, s3_idx, S3_AXIS)
    go_home()

    do_homing()
    go_home()

main()
